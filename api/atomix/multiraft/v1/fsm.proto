/*
SPDX-FileCopyrightText: 2022-present Open Networking Foundation <info@opennetworking.org>

SPDX-License-Identifier: Apache-2.0
*/

syntax = "proto3";

package atomix.multiraft.v1;

import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";
import "gogoproto/gogo.proto";

message PartitionCommandInput {
    uint32 partition_id = 1 [
        (gogoproto.customname) = "PartitionID",
        (gogoproto.casttype) = "PartitionID"
    ];
    CommandInput command = 2 [
        (gogoproto.nullable) = false
    ];
}

message PartitionCommandOutput {
    CommandOutput command = 1 [
        (gogoproto.nullable) = false
    ];
}

message CommandInput {
    google.protobuf.Timestamp timestamp = 1 [
        (gogoproto.stdtime) = true
    ];
    oneof input {
        OpenSessionInput open_session = 2;
        KeepAliveInput keep_alive = 3;
        CloseSessionInput close_session = 4;
        SessionCommandInput session_command = 5;
    }
}

message CommandOutput {
    uint64 index = 1 [
        (gogoproto.casttype) = "Index"
    ];
    oneof output {
        OpenSessionOutput open_session = 2;
        KeepAliveOutput keep_alive = 3;
        CloseSessionOutput close_session = 4;
        SessionCommandOutput session_command = 5;
    }
}

message OpenSessionInput {
    google.protobuf.Duration timeout = 1 [
        (gogoproto.stdduration) = true,
        (gogoproto.nullable) = false
    ];
}

message OpenSessionOutput {
    uint64 session_id = 1 [
        (gogoproto.customname) = "SessionID",
        (gogoproto.casttype) = "SessionID"
    ];
}

message KeepAliveInput {
    uint64 session_id = 1 [
        (gogoproto.customname) = "SessionID",
        (gogoproto.casttype) = "SessionID"
    ];
    bytes input_filter = 2;
    uint64 last_input_sequence_num = 3 [
        (gogoproto.casttype) = "SequenceNum"
    ];
    map<uint64, uint64> last_output_sequence_nums = 4 [
        (gogoproto.castkey) = "SequenceNum",
        (gogoproto.castvalue) = "SequenceNum"
    ];
}

message KeepAliveOutput {

}

message CloseSessionInput {
    uint64 session_id = 1 [
        (gogoproto.customname) = "SessionID",
        (gogoproto.casttype) = "SessionID"
    ];
}

message CloseSessionOutput {

}

message SessionCommandInput {
    uint64 session_id = 1 [
        (gogoproto.customname) = "SessionID",
        (gogoproto.casttype) = "SessionID"
    ];
    oneof input {
        CreateServiceInput create_service = 2;
        CloseServiceInput close_service = 3;
        ServiceCommandInput service_command = 4;
    }
}

message SessionCommandOutput {
    oneof output {
        CreateServiceOutput create_service = 1;
        CloseServiceOutput close_service = 2;
        ServiceCommandOutput service_command = 3;
    }
}

message CreateServiceInput {
    ServiceSpec spec = 1 [
        (gogoproto.nullable) = false,
        (gogoproto.embed) = true
    ];
}

message CreateServiceOutput {
    uint64 service_id = 1 [
        (gogoproto.customname) = "ServiceID",
        (gogoproto.casttype) = "ServiceID"
    ];
}

message CloseServiceInput {
    uint64 service_id = 1 [
        (gogoproto.customname) = "ServiceID",
        (gogoproto.casttype) = "ServiceID"
    ];
}

message CloseServiceOutput {

}

message ServiceCommandInput {
    uint64 service_id = 1 [
        (gogoproto.customname) = "ServiceID",
        (gogoproto.casttype) = "ServiceID"
    ];
    uint64 sequence_num = 2 [
        (gogoproto.casttype) = "SequenceNum"
    ];
    OperationInput operation = 3;
}

message ServiceCommandOutput {
    uint64 sequence_num = 1 [
        (gogoproto.casttype) = "SequenceNum"
    ];
    OperationOutput operation = 2;
}

message PartitionQueryInput {
    uint32 partition_id = 1 [
        (gogoproto.customname) = "PartitionID",
        (gogoproto.casttype) = "PartitionID"
    ];
    QueryInput query = 2 [
        (gogoproto.nullable) = false
    ];
    bool sync = 3;
}

message PartitionQueryOutput {
    QueryOutput query = 1 [
        (gogoproto.nullable) = false
    ];
}

message QueryInput {
    uint64 max_received_index = 1 [
        (gogoproto.casttype) = "Index"
    ];
    oneof input {
        SessionQueryInput session_query = 2;
    }
}

message QueryOutput {
    oneof output {
        SessionQueryOutput session_query = 1;
    }
}

message SessionQueryInput {
    uint64 session_id = 1 [
        (gogoproto.customname) = "SessionID",
        (gogoproto.casttype) = "SessionID"
    ];
    oneof input {
        ServiceQueryInput service_query = 2;
    }
}

message SessionQueryOutput {
    oneof output {
        ServiceQueryOutput service_query = 1;
    }
}

message ServiceQueryInput {
    uint64 service_id = 1 [
        (gogoproto.customname) = "ServiceID",
        (gogoproto.casttype) = "ServiceID"
    ];
    OperationInput operation = 2;
}

message ServiceQueryOutput {
    OperationOutput operation = 1;
}

message OperationInput {
    string name = 1;
    bytes payload = 2;
}

message OperationOutput {
    Status status = 1;
    bytes payload = 2;
    string message = 3;

    enum Status {
        UNKNOWN = 0;
        OK = 1;
        ERROR = 2;
        CANCELED = 3;
        NOT_FOUND = 4;
        ALREADY_EXISTS = 5;
        UNAUTHORIZED = 6;
        FORBIDDEN = 7;
        CONFLICT = 8;
        INVALID = 9;
        UNAVAILABLE = 10;
        NOT_SUPPORTED = 11;
        TIMEOUT = 12;
        INTERNAL = 13;
    }
}

message PartitionSnapshot {
    uint64 index = 1 [(gogoproto.casttype) = "Index"];
    google.protobuf.Timestamp timestamp = 2 [
        (gogoproto.stdtime) = true,
        (gogoproto.nullable) = false
    ];
    repeated SessionSnapshot sessions = 3;
    repeated ServiceSnapshot services = 4;
}

message SessionSnapshot {
    uint64 session_id = 1 [
        (gogoproto.customname) = "SessionID",
        (gogoproto.casttype) = "SessionID"
    ];
    google.protobuf.Duration timeout = 2 [
        (gogoproto.stdduration) = true,
        (gogoproto.nullable) = false
    ];
    google.protobuf.Timestamp last_updated = 3 [
        (gogoproto.stdtime) = true,
        (gogoproto.nullable) = false
    ];
    repeated CommandSnapshot commands = 4;
}

message CommandSnapshot {
    uint64 command_sequence_num = 1 [
        (gogoproto.casttype) = "CommandSequenceNum"
    ];
    CommandState state = 2;
    ServiceCommandInput input = 3;
    repeated ServiceCommandOutput pending_outputs = 4 [
        (gogoproto.nullable) = false
    ];
}

enum CommandState {
    COMMAND_OPEN = 0;
    COMMAND_COMPLETE = 1;
}

message ServiceSnapshot {
    uint64 service_id = 1 [
        (gogoproto.customname) = "ServiceID",
        (gogoproto.casttype) = "ServiceID"
    ];
    ServiceSpec spec = 2 [
        (gogoproto.nullable) = false
    ];
    bytes data = 3;
    repeated uint64 sessions = 4 [
        (gogoproto.customname) = "SessionID",
        (gogoproto.casttype) = "SessionID"
    ];
}

message ServiceSpec {
    string service = 1;
    string namespace = 2;
    string name = 3;
}
